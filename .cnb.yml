main:
  auto_tag:
    - stages:
        - name: auto tag
          image: "cnbcool/git-auto-tag:latest"
          settings:
            tagFormat: 'v\${version}'
            branch: $CNB_BRANCH
            repoUrlHttps: $CNB_REPO_URL_HTTPS
          exports:
            tag: NEW_TAG
        - name: show tag
          script: echo $NEW_TAG
  push:
    - name: ç¼–è¯‘æ„å»º
      docker:
        # å£°æ˜å¼çš„æ„å»ºç¯å¢ƒ https://docs.cnb.cool/
        # å¯ä»¥å»dockerhubä¸Š https://hub.docker.com/_/maven æ‰¾åˆ°æ‚¨éœ€è¦mavenå’Œjdkç‰ˆæœ¬
        image: maven:3.9.9-amazoncorretto-21
        volumes:
          # å£°æ˜å¼çš„æ„å»ºç¼“å­˜ https://docs.cnb.cool/zh/grammar/pipeline.html#volumes
          - /root/.m2:copy-on-write
      services:
        # æµæ°´çº¿ä¸­å¯ç”¨ docker in docker
        - docker
      stages:
        - name: æ£€æŸ¥å˜æ›´æ–‡ä»¶
          script:
            - echo "æ£€æŸ¥å˜æ›´çš„æ–‡ä»¶..."
            - git diff --name-only HEAD~1 HEAD > changed_files.txt
            - cat changed_files.txt
        - name: AuthæœåŠ¡æ‰“åŒ…
          script:
            # åªæœ‰å½“authç›¸å…³æ–‡ä»¶å˜æ›´æ—¶æ‰æ„å»º
            - |
              if grep -E "(qing-services/qing-service-auth|qing-commons|qing-domain-common|qing-infrastructure|qing-bom|pom.xml)" changed_files.txt; then
                echo "æ£€æµ‹åˆ°AuthæœåŠ¡ç›¸å…³å˜æ›´ï¼Œå¼€å§‹æ„å»º..."
                mvn clean package -pl qing-services/qing-service-auth/auth-interfaces -am -f pom.xml -T 2C --batch-mode
              else
                echo "æœªæ£€æµ‹åˆ°AuthæœåŠ¡ç›¸å…³å˜æ›´ï¼Œè·³è¿‡æ„å»º"
              fi
        - name: AnimeæœåŠ¡æ‰“åŒ…
          script:
            # åªæœ‰å½“animeç›¸å…³æ–‡ä»¶å˜æ›´æ—¶æ‰æ„å»º
            - |
              if grep -E "(qing-services/qing-service-anime|qing-commons|qing-domain-common|qing-infrastructure|qing-bom|pom.xml)" changed_files.txt; then
                echo "æ£€æµ‹åˆ°AnimeæœåŠ¡ç›¸å…³å˜æ›´ï¼Œå¼€å§‹æ„å»º..."
                mvn clean package -pl qing-services/qing-service-anime/anime-interfaces -am -f pom.xml -T 2C --batch-mode
              else
                echo "æœªæ£€æµ‹åˆ°AnimeæœåŠ¡ç›¸å…³å˜æ›´ï¼Œè·³è¿‡æ„å»º"
              fi
        # äº‘åŸç”Ÿæ„å»ºè‡ªåŠ¨æ„å»ºDockeré•œåƒå¹¶å°†å®ƒå‘å¸ƒåˆ°åˆ¶å“åº“ï¼Œã€ä¸Šä¼ Dockeråˆ¶å“ã€‘https://docs.cnb.cool/zh/artifact/docker.html
        - name: echo tag name
          script:
            - echo current branch $CNB_BRANCH
        - name: ç¼“å­˜Mavenä¾èµ–
          script:
            - echo "è®¾ç½®Mavenç¼“å­˜..."
            - mkdir -p ~/.m2/repository
            - echo "Mavenç¼“å­˜ç›®å½•: ~/.m2/repository"
        - name: æäº¤æ³¨é‡Šçš„å¯è¯»æ€§æ£€æµ‹
          image: cnbcool/ai-review:latest
          settings:
            type: commit-message-readability-check
          exports:
            status: STATUS
        - name: æäº¤æ³¨é‡Šçš„å¯è¯»æ€§æ£€æµ‹ç»“æœ
          script: echo $STATUS
  pull_request:
    - name: PRå˜æ›´åˆ†æ
      docker:
        image: maven:3.9.9-amazoncorretto-21
        volumes:
          - /root/.m2:copy-on-write
      stages:
        - name: å˜æ›´æ–‡ä»¶åˆ†æ
          script:
            - echo "åˆ†ææœ¬æ¬¡PRçš„å˜æ›´æ–‡ä»¶..."
            - git diff --name-only HEAD~1 HEAD > pr_changed_files.txt
            - echo "å˜æ›´çš„æ–‡ä»¶åˆ—è¡¨:"
            - cat pr_changed_files.txt
            - |
              echo "## ğŸ“‹ å˜æ›´æ€»ç»“" > pr_summary.md
              echo "" >> pr_summary.md
              
              # æ£€æŸ¥å„ä¸ªæ¨¡å—çš„å˜æ›´
              anime_changed=false
              auth_changed=false
              common_changed=false
              infra_changed=false
              ci_changed=false
              
              if grep -q "qing-services/qing-service-anime" pr_changed_files.txt; then
                echo "- ğŸ¬ **AnimeæœåŠ¡**: æ£€æµ‹åˆ°å˜æ›´" >> pr_summary.md
                anime_changed=true
              fi
              
              if grep -q "qing-services/qing-service-auth" pr_changed_files.txt; then
                echo "- ğŸ” **AuthæœåŠ¡**: æ£€æµ‹åˆ°å˜æ›´" >> pr_summary.md
                auth_changed=true
              fi
              
              if grep -q "qing-commons" pr_changed_files.txt; then
                echo "- ğŸ”§ **å…¬å…±æ¨¡å—**: æ£€æµ‹åˆ°å˜æ›´" >> pr_summary.md
                common_changed=true
              fi
              
              if grep -q "qing-infrastructure" pr_changed_files.txt; then
                echo "- ğŸ—ï¸ **åŸºç¡€è®¾æ–½**: æ£€æµ‹åˆ°å˜æ›´" >> pr_summary.md
                infra_changed=true
              fi
              
              if grep -q "\.cnb\.yml\|charts/" pr_changed_files.txt; then
                echo "- âš™ï¸ **CI/CDé…ç½®**: æ£€æµ‹åˆ°å˜æ›´" >> pr_summary.md
                ci_changed=true
              fi
              
              # æ·»åŠ æ„å»ºå»ºè®®
              echo "" >> pr_summary.md
              echo "### ğŸš€ æ„å»ºå»ºè®®" >> pr_summary.md
              if [ "$anime_changed" = true ] || [ "$common_changed" = true ] || [ "$infra_changed" = true ]; then
                echo "- éœ€è¦æ„å»º Anime æœåŠ¡" >> pr_summary.md
              fi
              if [ "$auth_changed" = true ] || [ "$common_changed" = true ] || [ "$infra_changed" = true ]; then
                echo "- éœ€è¦æ„å»º Auth æœåŠ¡" >> pr_summary.md
              fi
              if [ "$ci_changed" = true ]; then
                echo "- éœ€è¦éªŒè¯ CI/CD é…ç½®" >> pr_summary.md
              fi
              
              echo "" >> pr_summary.md
              echo "### ğŸ“ å˜æ›´æ–‡ä»¶è¯¦æƒ…" >> pr_summary.md
              echo "\`\`\`" >> pr_summary.md
              cat pr_changed_files.txt >> pr_summary.md
              echo "\`\`\`" >> pr_summary.md
              
              echo "å˜æ›´æ€»ç»“å·²ç”Ÿæˆ:"
              cat pr_summary.md
        - name: å˜æ›´æ€»ç»“
          image: cnbcool/ai-review:latest
          settings:
            type: diff-summary
          exports:
            summary: SUMMARY
        - name: å˜æ›´æ€»ç»“ç»“æœ
          script: echo $SUMMARY

# å¯¹æ‰€æœ‰ tag ç”Ÿæ•ˆ
v*.*.*:
  tag_push:
    - name: æ„å»ºé•œåƒ
      docker:
        # å£°æ˜å¼çš„æ„å»ºç¯å¢ƒ https://docs.cnb.cool/
        # å¯ä»¥å»dockerhubä¸Š https://hub.docker.com/_/maven æ‰¾åˆ°éœ€è¦mavenå’Œjdkç‰ˆæœ¬
        image: maven:3.9.9-amazoncorretto-21
        volumes:
          - /root/.m2:copy-on-write
      services:
        - docker
      environment:
        DOCKER_BUILDKIT: 1
        BUILDKIT_PROGRESS: plain
        MAVEN_OPTS: "-Dmaven.repo.local=/root/.m2/repository -Xmx2048m -XX:MaxMetaspaceSize=512m"
      stages:
        - name: æ£€æŸ¥æ ‡ç­¾å˜æ›´
          script:
            - echo "æ£€æŸ¥æ ‡ç­¾ $CNB_BRANCH å¯¹åº”çš„å˜æ›´..."
            - git diff --name-only HEAD~1 HEAD > tag_changed_files.txt
            - cat tag_changed_files.txt
        
        - name: å¹¶è¡ŒMavenæ„å»º
          script:
            - echo "å¼€å§‹å¹¶è¡Œæ„å»ºæœåŠ¡..."
            - |
              # æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»ºAnimeæœåŠ¡
              if grep -E "(qing-services/qing-service-anime|qing-commons|qing-domain-common|qing-infrastructure|qing-bom|pom.xml)" tag_changed_files.txt; then
                echo "æ„å»ºAnimeæœåŠ¡..."
                mvn clean package -pl qing-services/qing-service-anime/anime-interfaces -am -f pom.xml -T 2C --batch-mode &
                ANIME_PID=$!
              fi
              
              # æ£€æŸ¥æ˜¯å¦éœ€è¦æ„å»ºAuthæœåŠ¡
              if grep -E "(qing-services/qing-service-auth|qing-commons|qing-domain-common|qing-infrastructure|qing-bom|pom.xml)" tag_changed_files.txt; then
                echo "æ„å»ºAuthæœåŠ¡..."
                mvn clean package -pl qing-services/qing-service-auth/auth-interfaces -am -f pom.xml -T 2C --batch-mode &
                AUTH_PID=$!
              fi
              
              # ç­‰å¾…æ‰€æœ‰æ„å»ºå®Œæˆ
              if [ ! -z "$ANIME_PID" ]; then
                wait $ANIME_PID
                echo "AnimeæœåŠ¡æ„å»ºå®Œæˆ"
              fi
              if [ ! -z "$AUTH_PID" ]; then
                wait $AUTH_PID
                echo "AuthæœåŠ¡æ„å»ºå®Œæˆ"
              fi
        
        - name: echo tag name
          script:
            - echo  å½“å‰å‘å¸ƒtagç‰ˆæœ¬ï¼š$CNB_BRANCH
        
        - name: docker login
          script:
            - docker login -u ${CNB_TOKEN_USER_NAME} -p "${CNB_TOKEN}" ${CNB_DOCKER_REGISTRY}
        
        - name: å¹¶è¡Œæ„å»ºDockeré•œåƒ
          script:
            - |
              # å¹¶è¡Œæ„å»ºDockeré•œåƒ
              if [ -f "qing-services/qing-service-anime/anime-interfaces/target/*.jar" ]; then
                echo "æ„å»ºAnime Dockeré•œåƒ..."
                docker build --cache-from ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-anime:latest \
                  -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-anime:${CNB_COMMIT} \
                  -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-anime:latest \
                  ${CNB_BUILD_WORKSPACE}/qing-services/qing-service-anime/anime-interfaces/ &
                ANIME_DOCKER_PID=$!
              fi
              
              if [ -f "qing-services/qing-service-auth/auth-interfaces/target/*.jar" ]; then
                echo "æ„å»ºAuth Dockeré•œåƒ..."
                docker build --cache-from ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-auth:latest \
                  -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-auth:${CNB_COMMIT} \
                  -t ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-auth:latest \
                  ${CNB_BUILD_WORKSPACE}/qing-services/qing-service-auth/auth-interfaces/ &
                AUTH_DOCKER_PID=$!
              fi
              
              # ç­‰å¾…Dockeræ„å»ºå®Œæˆ
              if [ ! -z "$ANIME_DOCKER_PID" ]; then
                wait $ANIME_DOCKER_PID
                echo "Anime Dockeré•œåƒæ„å»ºå®Œæˆ"
              fi
              if [ ! -z "$AUTH_DOCKER_PID" ]; then
                wait $AUTH_DOCKER_PID
                echo "Auth Dockeré•œåƒæ„å»ºå®Œæˆ"
              fi
        
        - name: æ¨é€Dockeré•œåƒ
          script:
            - |
              # æ¨é€Animeé•œåƒ
              if docker images | grep -q "${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-anime:${CNB_COMMIT}"; then
                echo "æ¨é€Animeé•œåƒ..."
                docker push ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-anime:${CNB_COMMIT} &
                docker push ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-anime:latest &
              fi
              
              # æ¨é€Authé•œåƒ
              if docker images | grep -q "${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-auth:${CNB_COMMIT}"; then
                echo "æ¨é€Authé•œåƒ..."
                docker push ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-auth:${CNB_COMMIT} &
                docker push ${CNB_DOCKER_REGISTRY}/${CNB_REPO_SLUG_LOWERCASE}-auth:latest &
              fi
              
              # ç­‰å¾…æ‰€æœ‰æ¨é€å®Œæˆ
              wait
              echo "æ‰€æœ‰é•œåƒæ¨é€å®Œæˆ"
    - name: å‘å¸ƒchart
      docker:
        image: alpine/helm
      services:
        - docker
      stages:
        - name: echo final tag name
          script: echo $CNB_BRANCH
        - name: helm login
          script: helm registry login -u ${CNB_TOKEN_USER_NAME} -p "${CNB_TOKEN}" ${CNB_HELM_REGISTRY}
        - name: helm package
          script: helm package charts/qing
        - name: helm push
          script: helm push qing-0.1.0.tgz oci://${CNB_HELM_REGISTRY}/${CNB_GROUP_SLUG_LOWERCASE}

$:
  push:
    - name: tag æ¨é€
      stages:
        - name: echo tag name
          script:
            - echo  current branch $CNB_BRANCH
