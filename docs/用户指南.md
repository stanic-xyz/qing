# 用户指南

## 📖 概述

本指南将帮助您全面了解和使用Project-青微服务平台，从基础概念到高级功能，提供详细的使用说明和最佳实践。

## 🎯 目标用户

- **后端开发者** - 使用平台进行微服务开发
- **架构师** - 了解系统架构和设计理念
- **运维工程师** - 部署和维护系统
- **产品经理** - 了解平台功能和业务价值

## 🏗️ 系统架构

### 整体架构

Project-青采用领域驱动设计(DDD)和六边形架构，构建了高内聚、低耦合的微服务体系：

```
┌─────────────────────────────────────────────────────────────┐
│                    用户界面层 (UI Layer)                      │
├─────────────────────────────────────────────────────────────┤
│                   应用服务层 (Application)                    │
├─────────────────────────────────────────────────────────────┤
│                    领域层 (Domain)                          │
├─────────────────────────────────────────────────────────────┤
│                  基础设施层 (Infrastructure)                  │
└─────────────────────────────────────────────────────────────┘
```

### 核心组件

| 组件 | 功能 | 技术栈 |
|------|------|--------|
| **服务网关** | 统一入口、路由、限流 | Spring Cloud Gateway |
| **注册中心** | 服务发现与注册 | Nacos |
| **配置中心** | 统一配置管理 | Nacos Config |
| **认证中心** | 统一身份认证 | SA-Token + JWT |
| **监控中心** | 系统监控与告警 | Prometheus + Grafana |

## 🚀 快速上手

### 环境要求

- **JDK**: 17+
- **Maven**: 3.8+
- **Docker**: 20.10+
- **Node.js**: 16+ (前端开发)

### 本地开发环境搭建

#### 1. 克隆项目

```bash
# 后端项目
git clone https://gitee.com/stanChen/qing.git
cd qing

# 前端项目（可选）
git clone https://gitee.com/stanChen/qing-frontend.git
```

#### 2. 启动基础设施

```bash
# 启动 MySQL、Redis、Nacos 等基础服务
docker-compose -f scripts/docker-compose-infra.yml up -d

# 查看服务状态
docker-compose -f scripts/docker-compose-infra.yml ps
```

#### 3. 初始化数据库

```bash
# 执行数据库初始化脚本
mysql -h localhost -P 3306 -u root -p < scripts/init-db.sql
```

#### 4. 编译项目

```bash
# 编译所有模块
mvn clean install -DskipTests

# 或者编译指定模块
mvn clean install -pl qing-services/qing-service-auth -am
```

#### 5. 启动服务

```bash
# 方式1：使用Maven启动
mvn spring-boot:run -pl qing-services/qing-service-auth
mvn spring-boot:run -pl qing-service-cloud-gateway

# 方式2：使用JAR包启动
java -jar qing-services/qing-service-auth/target/*.jar
java -jar qing-service-cloud-gateway/target/*.jar
```

## 🔧 核心功能使用

### 代码生成器

代码生成器是平台的核心工具，可以快速生成标准的DDD代码结构。

#### 基本使用

1. **定义实体类**

```java
@Entity
@GenCode
public class Product {
    @Id
    private Long id;
    
    @GenField(label = "产品名称")
    private String name;
    
    @GenField(label = "价格")
    private BigDecimal price;
    
    // getter/setter...
}
```

2. **编译生成代码**

```bash
mvn compile
```

3. **生成的代码结构**

```
src/main/java/
├── controller/
│   └── ProductController.java      # REST控制器
├── service/
│   ├── IProductService.java        # 服务接口
│   └── impl/ProductServiceImpl.java # 服务实现
├── repository/
│   └── ProductRepository.java      # 数据仓储
└── dto/
    ├── ProductCreateRequest.java   # 创建请求DTO
    ├── ProductUpdateRequest.java   # 更新请求DTO
    └── ProductResponse.java        # 响应DTO
```

#### 高级配置

```java
@Entity
@GenCode(
    moduleName = "product",           // 模块名
    packageName = "com.example",      // 包名
    author = "张三",                  // 作者
    tableComment = "产品管理"          // 表注释
)
public class Product {
    @GenField(
        label = "产品名称",
        required = true,              // 必填
        length = 100,                // 长度限制
        comment = "产品的显示名称"      // 字段注释
    )
    private String name;
}
```

### 认证与授权

#### 用户登录

```bash
# 登录接口
POST /api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "123456"
}

# 响应
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "userInfo": {
      "id": 1,
      "username": "admin",
      "roles": ["ADMIN"]
    }
  }
}
```

#### 接口调用

```bash
# 在请求头中携带token
GET /api/products
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 权限控制

```java
@RestController
@RequestMapping("/api/products")
public class ProductController {
    
    @GetMapping
    @SaCheckRole("USER")  // 需要USER角色
    public List<Product> list() {
        return productService.list();
    }
    
    @PostMapping
    @SaCheckPermission("product:create")  // 需要创建权限
    public Product create(@RequestBody ProductCreateRequest request) {
        return productService.create(request);
    }
}
```

### 数据库操作

#### JPA Repository

```java
@Repository
public interface ProductRepository extends JpaRepository<Product, Long> {
    
    // 根据名称查询
    List<Product> findByNameContaining(String name);
    
    // 根据价格范围查询
    @Query("SELECT p FROM Product p WHERE p.price BETWEEN :minPrice AND :maxPrice")
    List<Product> findByPriceRange(@Param("minPrice") BigDecimal minPrice, 
                                  @Param("maxPrice") BigDecimal maxPrice);
    
    // 分页查询
    Page<Product> findByStatus(ProductStatus status, Pageable pageable);
}
```

#### 事务管理

```java
@Service
@Transactional
public class ProductServiceImpl implements IProductService {
    
    @Override
    public Product create(ProductCreateRequest request) {
        // 业务逻辑
        Product product = new Product();
        BeanUtils.copyProperties(request, product);
        
        // 保存到数据库
        return productRepository.save(product);
    }
    
    @Override
    @Transactional(rollbackFor = Exception.class)
    public void batchUpdate(List<ProductUpdateRequest> requests) {
        // 批量更新操作
        requests.forEach(request -> {
            Product product = productRepository.findById(request.getId())
                .orElseThrow(() -> new BusinessException("产品不存在"));
            BeanUtils.copyProperties(request, product);
            productRepository.save(product);
        });
    }
}
```

### API文档

系统集成了Knife4j，提供了美观的API文档界面。

#### 访问文档

- **开发环境**: http://localhost:8080/doc.html
- **测试环境**: http://test.example.com/doc.html

#### 接口注解

```java
@RestController
@RequestMapping("/api/products")
@Api(tags = "产品管理")
public class ProductController {
    
    @GetMapping
    @ApiOperation("查询产品列表")
    @ApiImplicitParams({
        @ApiImplicitParam(name = "name", value = "产品名称", paramType = "query"),
        @ApiImplicitParam(name = "status", value = "产品状态", paramType = "query")
    })
    public Result<List<ProductResponse>> list(
        @RequestParam(required = false) String name,
        @RequestParam(required = false) ProductStatus status) {
        // 实现逻辑
    }
}
```

## 🔍 监控与运维

### 健康检查

```bash
# 检查服务健康状态
GET /actuator/health

# 响应
{
  "status": "UP",
  "components": {
    "db": {
      "status": "UP",
      "details": {
        "database": "MySQL",
        "validationQuery": "isValid()"
      }
    },
    "redis": {
      "status": "UP",
      "details": {
        "version": "6.2.6"
      }
    }
  }
}
```

### 性能指标

```bash
# 查看JVM指标
GET /actuator/metrics/jvm.memory.used

# 查看HTTP请求指标
GET /actuator/metrics/http.server.requests
```

### 日志管理

```bash
# 查看日志级别
GET /actuator/loggers

# 动态修改日志级别
POST /actuator/loggers/com.example.service
Content-Type: application/json

{
  "configuredLevel": "DEBUG"
}
```

## 🛠️ 开发最佳实践

### 代码规范

1. **包结构规范**

```
com.example.product/
├── controller/          # 控制器层
├── service/            # 服务层
│   └── impl/
├── repository/         # 数据访问层
├── domain/            # 领域模型
│   ├── entity/        # 实体
│   ├── vo/           # 值对象
│   └── event/        # 领域事件
├── dto/              # 数据传输对象
│   ├── request/      # 请求DTO
│   └── response/     # 响应DTO
└── config/           # 配置类
```

2. **命名规范**

- **类名**: 使用大驼峰命名法，如 `ProductService`
- **方法名**: 使用小驼峰命名法，如 `findByName`
- **常量**: 使用全大写+下划线，如 `MAX_RETRY_COUNT`
- **包名**: 使用小写字母，如 `com.example.product`

3. **异常处理**

```java
@ControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public Result<Void> handleBusinessException(BusinessException e) {
        log.warn("业务异常: {}", e.getMessage());
        return Result.fail(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public Result<Void> handleException(Exception e) {
        log.error("系统异常", e);
        return Result.fail("系统异常，请稍后重试");
    }
}
```

### 性能优化

1. **数据库优化**

```java
// 使用索引
@Entity
@Table(indexes = {
    @Index(name = "idx_name", columnList = "name"),
    @Index(name = "idx_status_created", columnList = "status,createdAt")
})
public class Product {
    // ...
}

// 批量操作
@Modifying
@Query("UPDATE Product p SET p.status = :status WHERE p.id IN :ids")
int batchUpdateStatus(@Param("status") ProductStatus status, @Param("ids") List<Long> ids);
```

2. **缓存使用**

```java
@Service
public class ProductService {
    
    @Cacheable(value = "products", key = "#id")
    public Product findById(Long id) {
        return productRepository.findById(id).orElse(null);
    }
    
    @CacheEvict(value = "products", key = "#product.id")
    public Product update(Product product) {
        return productRepository.save(product);
    }
}
```

## 🔧 故障排查

### 常见问题

1. **服务启动失败**

```bash
# 检查端口占用
netstat -tulpn | grep :8080

# 检查配置文件
cat application.yml

# 查看启动日志
tail -f logs/application.log
```

2. **数据库连接失败**

```bash
# 检查数据库服务
docker ps | grep mysql

# 测试连接
mysql -h localhost -P 3306 -u root -p

# 检查配置
grep -A 5 "datasource" application.yml
```

3. **接口调用超时**

```bash
# 检查网络连通性
ping target-service

# 检查服务注册
curl http://localhost:8848/nacos/v1/ns/instance/list?serviceName=product-service

# 查看调用链路
grep "traceId" logs/application.log
```

### 日志分析

```bash
# 查看错误日志
grep "ERROR" logs/application.log | tail -20

# 查看特定时间段日志
awk '/2024-01-01 10:00:00/,/2024-01-01 11:00:00/' logs/application.log

# 统计接口调用次数
grep "ProductController" logs/application.log | wc -l
```

## 📞 技术支持

- **文档中心**: [docs/](../docs/)
- **问题反馈**: [Issues](https://gitee.com/stanChen/qing/issues)
- **技术交流**: QQ群 123456789
- **邮件支持**: support@example.com

## 📚 相关资源

- [Spring Boot官方文档](https://spring.io/projects/spring-boot)
- [Spring Cloud Alibaba文档](https://spring-cloud-alibaba-group.github.io/github-pages/hoxton/zh-cn/index.html)
- [DDD领域驱动设计](https://domain-driven-design.org/)
- [六边形架构](https://alistair.cockburn.us/hexagonal-architecture/)

---

> 💡 **提示**: 如果您在使用过程中遇到问题，请先查看本指南的故障排查部分，或者查阅相关技术文档。如果问题仍未解决，欢迎提交Issue或联系技术支持。