# éƒ¨ç½²æŒ‡å—

> ğŸš€ Project-é’å¾®æœåŠ¡å¹³å°ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæ•´æŒ‡å—

## ğŸ“– æ¦‚è¿°

æœ¬æŒ‡å—å°†è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨ä¸åŒç¯å¢ƒä¸­éƒ¨ç½²Project-é’å¾®æœåŠ¡å¹³å°ï¼ŒåŒ…æ‹¬å¼€å‘ç¯å¢ƒã€æµ‹è¯•ç¯å¢ƒå’Œç”Ÿäº§ç¯å¢ƒçš„éƒ¨ç½²æ–¹æ¡ˆã€‚

### éƒ¨ç½²æ¶æ„å¯¹æ¯”

| ç¯å¢ƒç±»å‹ | éƒ¨ç½²æ–¹å¼ | èµ„æºé…ç½® | é«˜å¯ç”¨ | ç›‘æ§ |
|----------|----------|----------|--------|---------|
| **å¼€å‘ç¯å¢ƒ** | Docker Compose | æœ€å°é…ç½® | âŒ | åŸºç¡€ç›‘æ§ |
| **æµ‹è¯•ç¯å¢ƒ** | Docker Swarm | ä¸­ç­‰é…ç½® | âœ… | å®Œæ•´ç›‘æ§ |
| **ç”Ÿäº§ç¯å¢ƒ** | Kubernetes | é«˜é…ç½® | âœ… | å…¨é¢ç›‘æ§ |

## ğŸ› ï¸ ç¯å¢ƒå‡†å¤‡

### åŸºç¡€ç¯å¢ƒè¦æ±‚

#### ç¡¬ä»¶è¦æ±‚

| ç¯å¢ƒ | CPU | å†…å­˜ | ç£ç›˜ | ç½‘ç»œ |
|------|-----|------|------|------|
| **å¼€å‘ç¯å¢ƒ** | 4æ ¸+ | 8GB+ | 50GB+ | 100Mbps+ |
| **æµ‹è¯•ç¯å¢ƒ** | 8æ ¸+ | 16GB+ | 200GB+ | 1Gbps+ |
| **ç”Ÿäº§ç¯å¢ƒ** | 16æ ¸+ | 32GB+ | 500GB+ | 10Gbps+ |

#### è½¯ä»¶è¦æ±‚

```bash
# æ“ä½œç³»ç»Ÿ
CentOS 7.9+ / Ubuntu 18.04+ / RHEL 7+

# å®¹å™¨è¿è¡Œæ—¶
Docker 20.10+
Docker Compose 2.0+

# ç¼–æ’å·¥å…·ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰
Kubernetes 1.20+
Helm 3.0+

# ç›‘æ§å·¥å…·
Prometheus 2.30+
Grafana 8.0+
```

### ç½‘ç»œè§„åˆ’

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ç½‘ç»œæ¶æ„è§„åˆ’                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç½‘ç»œå±‚çº§        â”‚  ç½‘æ®µè§„åˆ’        â”‚  ç«¯å£è§„åˆ’            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è´Ÿè½½å‡è¡¡å±‚      â”‚  10.0.1.0/24     â”‚  80, 443             â”‚
â”‚  ç½‘å…³å±‚          â”‚  10.0.2.0/24     â”‚  8080                â”‚
â”‚  åº”ç”¨æœåŠ¡å±‚      â”‚  10.0.3.0/24     â”‚  8081-8090           â”‚
â”‚  æ•°æ®å­˜å‚¨å±‚      â”‚  10.0.4.0/24     â”‚  3306, 6379, 27017   â”‚
â”‚  åŸºç¡€è®¾æ–½å±‚      â”‚  10.0.5.0/24     â”‚  8848, 9092, 2181    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ³ Dockeréƒ¨ç½²

### å¼€å‘ç¯å¢ƒéƒ¨ç½²

#### 1. å…‹éš†é¡¹ç›®

```bash
# å…‹éš†é¡¹ç›®ä»£ç 
git clone https://github.com/stanic-xyz/qing.git
# æˆ–è€…ä½¿ç”¨ Gitee
# git clone https://gitee.com/stanic-xyz/qing.git
cd qing

# æ£€æŸ¥é¡¹ç›®ç»“æ„
ls -la
```

#### 2. æ„å»ºé•œåƒ

```bash
# æ„å»ºæ‰€æœ‰æœåŠ¡é•œåƒ
./scripts/build-images.sh

# æˆ–è€…å•ç‹¬æ„å»º
docker build -t qing/auth-service:latest qing-services/qing-service-auth/
docker build -t qing/gateway-service:latest qing-service-cloud-gateway/
docker build -t qing/anime-service:latest qing-services/qing-service-anime/
```

#### 3. å¯åŠ¨åŸºç¡€è®¾æ–½

```bash
# å¯åŠ¨åŸºç¡€è®¾æ–½æœåŠ¡
docker-compose -f scripts/docker-compose-infra.yml up -d

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
docker-compose -f scripts/docker-compose-infra.yml ps
```

#### 4. åˆå§‹åŒ–æ•°æ®åº“

```bash
# ç­‰å¾…MySQLå¯åŠ¨å®Œæˆ
sleep 30

# æ‰§è¡Œåˆå§‹åŒ–è„šæœ¬
docker exec -i qing-mysql mysql -uroot -p123456 < scripts/init-db.sql

# éªŒè¯æ•°æ®åº“
docker exec qing-mysql mysql -uroot -p123456 -e "SHOW DATABASES;"
```

#### 5. å¯åŠ¨åº”ç”¨æœåŠ¡

```bash
# å¯åŠ¨æ‰€æœ‰åº”ç”¨æœåŠ¡
docker-compose -f scripts/docker-compose-app.yml up -d

# æŸ¥çœ‹æœåŠ¡æ—¥å¿—
docker-compose -f scripts/docker-compose-app.yml logs -f
```

#### 6. éªŒè¯éƒ¨ç½²

```bash
# æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
curl http://localhost:8080/actuator/health
curl http://localhost:8081/actuator/health
curl http://localhost:8082/actuator/health

# è®¿é—®APIæ–‡æ¡£
open http://localhost:8080/doc.html
```

### å®Œæ•´çš„docker-composeé…ç½®

åˆ›å»º `docker-compose.yml`ï¼š

```yaml
version: '3.8'

services:
  # åŸºç¡€è®¾æ–½æœåŠ¡
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: qing-nacos
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=nacos123
    ports:
      - "8848:8848"
    depends_on:
      - mysql
    networks:
      - qing-network

  mysql:
    image: mysql:8.0
    container_name: qing-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=qing
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - qing-network

  redis:
    image: redis:7-alpine
    container_name: qing-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - qing-network

  # åº”ç”¨æœåŠ¡
  auth-service:
    image: qing/auth-service:latest
    container_name: qing-auth-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    ports:
      - "8081:8081"
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - qing-network

  gateway-service:
    image: qing/gateway-service:latest
    container_name: qing-gateway-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
    ports:
      - "8080:8080"
    depends_on:
      - nacos
      - auth-service
    networks:
      - qing-network

  anime-service:
    image: qing/anime-service:latest
    container_name: qing-anime-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    ports:
      - "8082:8082"
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - qing-network

volumes:
  mysql-data:
  redis-data:

networks:
  qing-network:
    driver: bridge
```

## â˜¸ï¸ Kuberneteséƒ¨ç½²

### ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

#### 1. å‡†å¤‡Kubernetesé›†ç¾¤

```bash
# æ£€æŸ¥é›†ç¾¤çŠ¶æ€
kubectl cluster-info
kubectl get nodes

# åˆ›å»ºå‘½åç©ºé—´
kubectl create namespace qing-prod
kubectl config set-context --current --namespace=qing-prod
```

#### 2. å®‰è£…Helm

```bash
# å®‰è£…Helm
curl https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz | tar -xzO linux-amd64/helm > /usr/local/bin/helm
chmod +x /usr/local/bin/helm

# éªŒè¯å®‰è£…
helm version
```

#### 3. éƒ¨ç½²åŸºç¡€è®¾æ–½

##### MySQLéƒ¨ç½²

```yaml
# mysql-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: qing-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "123456"
        - name: MYSQL_DATABASE
          value: "qing"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: qing-prod
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: qing-prod
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
```

##### Rediséƒ¨ç½²

```yaml
# redis-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: qing-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-storage
          mountPath: /data
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: qing-prod
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: qing-prod
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

##### Nacoséƒ¨ç½²

```yaml
# nacos-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nacos
  namespace: qing-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nacos
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
      - name: nacos
        image: nacos/nacos-server:v2.2.3
        env:
        - name: MODE
          value: "standalone"
        - name: SPRING_DATASOURCE_PLATFORM
          value: "mysql"
        - name: MYSQL_SERVICE_HOST
          value: "mysql"
        - name: MYSQL_SERVICE_DB_NAME
          value: "nacos"
        - name: MYSQL_SERVICE_USER
          value: "nacos"
        - name: MYSQL_SERVICE_PASSWORD
          value: "nacos123"
        ports:
        - containerPort: 8848
---
apiVersion: v1
kind: Service
metadata:
  name: nacos
  namespace: qing-prod
spec:
  selector:
    app: nacos
  ports:
  - port: 8848
    targetPort: 8848
  type: ClusterIP
```

#### 4. éƒ¨ç½²åº”ç”¨æœåŠ¡

##### è®¤è¯æœåŠ¡

```yaml
# auth-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: qing-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: qing/auth-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: MYSQL_HOST
          value: "mysql"
        - name: REDIS_HOST
          value: "redis"
        ports:
        - containerPort: 8081
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: qing-prod
spec:
  selector:
    app: auth-service
  ports:
  - port: 8081
    targetPort: 8081
  type: ClusterIP
```

##### ç½‘å…³æœåŠ¡

```yaml
# gateway-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-service
  namespace: qing-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gateway-service
  template:
    metadata:
      labels:
        app: gateway-service
    spec:
      containers:
      - name: gateway-service
        image: qing/gateway-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: qing-prod
spec:
  selector:
    app: gateway-service
  ports:
  - port: 8080
    targetPort: 8080
  type: LoadBalancer
```

#### 5. æ‰§è¡Œéƒ¨ç½²

```bash
# éƒ¨ç½²åŸºç¡€è®¾æ–½
kubectl apply -f k8s/mysql-deployment.yaml
kubectl apply -f k8s/redis-deployment.yaml
kubectl apply -f k8s/nacos-deployment.yaml

# ç­‰å¾…åŸºç¡€è®¾æ–½å°±ç»ª
kubectl wait --for=condition=ready pod -l app=mysql --timeout=300s
kubectl wait --for=condition=ready pod -l app=redis --timeout=300s
kubectl wait --for=condition=ready pod -l app=nacos --timeout=300s

# éƒ¨ç½²åº”ç”¨æœåŠ¡
kubectl apply -f k8s/auth-service-deployment.yaml
kubectl apply -f k8s/gateway-service-deployment.yaml
kubectl apply -f k8s/anime-service-deployment.yaml

# æ£€æŸ¥éƒ¨ç½²çŠ¶æ€
kubectl get pods
kubectl get services
```

#### 6. é…ç½®Ingress

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: qing-ingress
  namespace: qing-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.qing.com
    secretName: qing-tls
  rules:
  - host: api.qing.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gateway-service
            port:
              number: 8080
```

## ğŸ“Š ç›‘æ§éƒ¨ç½²

### Prometheus + Grafana

#### 1. å®‰è£…Prometheus Operator

```bash
# æ·»åŠ Helmä»“åº“
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# å®‰è£…kube-prometheus-stack
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace \
  --set grafana.adminPassword=admin123
```

#### 2. é…ç½®ServiceMonitor

```yaml
# service-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: qing-services
  namespace: monitoring
spec:
  selector:
    matchLabels:
      monitoring: "true"
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 30s
```

#### 3. è®¿é—®ç›‘æ§ç•Œé¢

```bash
# è·å–Grafanaè®¿é—®åœ°å€
kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80

# è®¿é—® http://localhost:3000
# ç”¨æˆ·å: admin
# å¯†ç : admin123
```

### æ—¥å¿—æ”¶é›†

#### ELK Stackéƒ¨ç½²

```bash
# å®‰è£…Elasticsearch
helm repo add elastic https://helm.elastic.co
helm install elasticsearch elastic/elasticsearch \
  --namespace logging \
  --create-namespace

# å®‰è£…Kibana
helm install kibana elastic/kibana \
  --namespace logging

# å®‰è£…Filebeat
helm install filebeat elastic/filebeat \
  --namespace logging
```

## ğŸ”§ é…ç½®ç®¡ç†

### ç¯å¢ƒé…ç½®

#### å¼€å‘ç¯å¢ƒé…ç½®

```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/qing?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    rawPassword: 123456
  redis:
    host: localhost
    port: 6379
    database: 0

cloud:
  nacos:
    discovery:
      server-addr: localhost:8848
    config:
      server-addr: localhost:8848

logging:
  level:
    cn.chenyunlong: DEBUG
```

#### ç”Ÿäº§ç¯å¢ƒé…ç½®

```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:mysql://mysql:3306/qing?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: ${MYSQL_USERNAME:root}
    rawPassword: ${MYSQL_PASSWORD:123456}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  redis:
    host: ${REDIS_HOST:redis}
    port: ${REDIS_PORT:6379}
    database: 0
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5

cloud:
  nacos:
    discovery:
      server-addr: ${NACOS_SERVER_ADDR:nacos:8848}
    config:
      server-addr: ${NACOS_SERVER_ADDR:nacos:8848}

logging:
  level:
    root: INFO
    cn.chenyunlong: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### é…ç½®ä¸­å¿ƒç®¡ç†

#### Nacosé…ç½®

```bash
# åˆ›å»ºé…ç½®æ–‡ä»¶
curl -X POST "http://nacos:8848/nacos/v1/cs/configs" \
  -d "dataId=qing-gateway.yml" \
  -d "group=DEFAULT_GROUP" \
  -d "content=$(cat gateway-config.yml)"

# å‘å¸ƒé…ç½®
curl -X POST "http://nacos:8848/nacos/v1/cs/configs" \
  -d "dataId=qing-auth.yml" \
  -d "group=DEFAULT_GROUP" \
  -d "content=$(cat auth-config.yml)"
```

## ğŸš€ CI/CDæµæ°´çº¿

### GitLab CIé…ç½®

```yaml
# .gitlab-ci.yml
stages:
  - test
  - build
  - deploy

variables:
  DOCKER_REGISTRY: registry.example.com
  NAMESPACE: qing-prod

test:
  stage: test
  script:
    - mvn clean test
  only:
    - merge_requests
    - main

build:
  stage: build
  script:
    - mvn clean package -DskipTests
    - docker build -t $DOCKER_REGISTRY/qing/auth-service:$CI_COMMIT_SHA qing-services/qing-service-auth/
    - docker push $DOCKER_REGISTRY/qing/auth-service:$CI_COMMIT_SHA
  only:
    - main

deploy:
  stage: deploy
  script:
    - kubectl set image deployment/auth-service auth-service=$DOCKER_REGISTRY/qing/auth-service:$CI_COMMIT_SHA -n $NAMESPACE
    - kubectl rollout status deployment/auth-service -n $NAMESPACE
  only:
    - main
  when: manual
```

### Jenkins Pipeline

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'registry.example.com'
        NAMESPACE = 'qing-prod'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/stanic-xyz/qing.git'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn clean test'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
                sh 'docker build -t ${DOCKER_REGISTRY}/qing/auth-service:${BUILD_NUMBER} qing-services/qing-service-auth/'
                sh 'docker push ${DOCKER_REGISTRY}/qing/auth-service:${BUILD_NUMBER}'
            }
        }
        
        stage('Deploy') {
            steps {
                sh 'kubectl set image deployment/auth-service auth-service=${DOCKER_REGISTRY}/qing/auth-service:${BUILD_NUMBER} -n ${NAMESPACE}'
                sh 'kubectl rollout status deployment/auth-service -n ${NAMESPACE}'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
    }
}
```

## ğŸ” å¥åº·æ£€æŸ¥

### åº”ç”¨å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥æœåŠ¡çŠ¶æ€
kubectl get pods -n qing-prod
kubectl describe pod <pod-name> -n qing-prod

# æ£€æŸ¥æœåŠ¡æ—¥å¿—
kubectl logs -f deployment/auth-service -n qing-prod

# æ£€æŸ¥æœåŠ¡å¥åº·ç«¯ç‚¹
curl http://auth-service:8081/actuator/health
curl http://gateway-service:8080/actuator/health
```

### æ•°æ®åº“å¥åº·æ£€æŸ¥

```bash
# æ£€æŸ¥MySQLè¿æ¥
kubectl exec -it deployment/mysql -n qing-prod -- mysql -uroot -p123456 -e "SELECT 1"

# æ£€æŸ¥Redisè¿æ¥
kubectl exec -it deployment/redis -n qing-prod -- redis-cli ping
```

## ğŸ›¡ï¸ å®‰å…¨é…ç½®

### ç½‘ç»œå®‰å…¨

```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: qing-network-policy
  namespace: qing-prod
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: qing-prod
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: qing-prod
```

### RBACé…ç½®

```yaml
# rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: qing-service-account
  namespace: qing-prod
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: qing-role
  namespace: qing-prod
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: qing-role-binding
  namespace: qing-prod
subjects:
- kind: ServiceAccount
  name: qing-service-account
  namespace: qing-prod
roleRef:
  kind: Role
  name: qing-role
  apiGroup: rbac.authorization.k8s.io
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### JVMè°ƒä¼˜

```yaml
# åœ¨Deploymentä¸­é…ç½®JVMå‚æ•°
env:
- name: JAVA_OPTS
  value: "-Xms512m -Xmx1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGCDetails"
```

### èµ„æºé™åˆ¶

```yaml
resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "1Gi"
    cpu: "1000m"
```

## ğŸ”„ å¤‡ä»½æ¢å¤

### æ•°æ®åº“å¤‡ä»½

```bash
# åˆ›å»ºå¤‡ä»½è„šæœ¬
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p $BACKUP_DIR

# å¤‡ä»½æ•°æ®åº“
kubectl exec deployment/mysql -n qing-prod -- mysqldump -uroot -p123456 --all-databases > $BACKUP_DIR/backup_$DATE.sql

# å‹ç¼©å¤‡ä»½æ–‡ä»¶
gzip $BACKUP_DIR/backup_$DATE.sql

# åˆ é™¤7å¤©å‰çš„å¤‡ä»½
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

### é…ç½®å¤‡ä»½

```bash
# å¤‡ä»½Nacosé…ç½®
curl "http://nacos:8848/nacos/v1/cs/configs?export=true&group=DEFAULT_GROUP" > nacos_config_backup.zip

# å¤‡ä»½Kubernetesé…ç½®
kubectl get all -n qing-prod -o yaml > k8s_backup.yaml
```

## ğŸš¨ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### æœåŠ¡å¯åŠ¨å¤±è´¥

```bash
# æŸ¥çœ‹PodçŠ¶æ€
kubectl describe pod <pod-name> -n qing-prod

# æŸ¥çœ‹å®¹å™¨æ—¥å¿—
kubectl logs <pod-name> -c <container-name> -n qing-prod

# è¿›å…¥å®¹å™¨è°ƒè¯•
kubectl exec -it <pod-name> -n qing-prod -- /bin/bash
```

#### æ•°æ®åº“è¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥æ•°æ®åº“æœåŠ¡
kubectl get svc mysql -n qing-prod

# æµ‹è¯•æ•°æ®åº“è¿æ¥
kubectl run mysql-client --image=mysql:8.0 -it --rm --restart=Never -- mysql -h mysql -uroot -p123456
```

#### ç½‘ç»œè¿æ¥é—®é¢˜

```bash
# æ£€æŸ¥ç½‘ç»œç­–ç•¥
kubectl get networkpolicy -n qing-prod

# æµ‹è¯•æœåŠ¡è¿é€šæ€§
kubectl run test-pod --image=busybox -it --rm --restart=Never -- nslookup auth-service
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [å¿«é€Ÿå¼€å§‹](å¿«é€Ÿå¼€å§‹.md) - 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹
- [ç”¨æˆ·æŒ‡å—](ç”¨æˆ·æŒ‡å—.md) - è¯¦ç»†ä½¿ç”¨è¯´æ˜
- [æ¶æ„è®¾è®¡](æ¶æ„è®¾è®¡.md) - ç³»ç»Ÿæ¶æ„è®¾è®¡
- [ROADMAP](../ROADMAP.md) - é¡¹ç›®å‘å±•è·¯çº¿
- [CONTRIBUTING](../CONTRIBUTING.md) - è´¡çŒ®æŒ‡å—

---

> ğŸ’¡ **éƒ¨ç½²å»ºè®®**: å»ºè®®å…ˆåœ¨æµ‹è¯•ç¯å¢ƒéªŒè¯éƒ¨ç½²æµç¨‹ï¼Œç¡®è®¤æ— è¯¯åå†éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒã€‚ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·åŠ¡å¿…åšå¥½æ•°æ®å¤‡ä»½ã€‚
