# 部署指南

> 🚀 Project-青微服务平台生产环境部署完整指南

## 📖 概述

本指南将详细介绍如何在不同环境中部署Project-青微服务平台，包括开发环境、测试环境和生产环境的部署方案。

### 部署架构对比

| 环境类型 | 部署方式 | 资源配置 | 高可用 | 监控 |
|----------|----------|----------|--------|---------|
| **开发环境** | Docker Compose | 最小配置 | ❌ | 基础监控 |
| **测试环境** | Docker Swarm | 中等配置 | ✅ | 完整监控 |
| **生产环境** | Kubernetes | 高配置 | ✅ | 全面监控 |

## 🛠️ 环境准备

### 基础环境要求

#### 硬件要求

| 环境 | CPU | 内存 | 磁盘 | 网络 |
|------|-----|------|------|------|
| **开发环境** | 4核+ | 8GB+ | 50GB+ | 100Mbps+ |
| **测试环境** | 8核+ | 16GB+ | 200GB+ | 1Gbps+ |
| **生产环境** | 16核+ | 32GB+ | 500GB+ | 10Gbps+ |

#### 软件要求

```bash
# 操作系统
CentOS 7.9+ / Ubuntu 18.04+ / RHEL 7+

# 容器运行时
Docker 20.10+
Docker Compose 2.0+

# 编排工具（生产环境）
Kubernetes 1.20+
Helm 3.0+

# 监控工具
Prometheus 2.30+
Grafana 8.0+
```

### 网络规划

```
┌─────────────────────────────────────────────────────────────┐
│                    网络架构规划                              │
├─────────────────────────────────────────────────────────────┤
│  网络层级        │  网段规划        │  端口规划            │
├─────────────────────────────────────────────────────────────┤
│  负载均衡层      │  10.0.1.0/24     │  80, 443             │
│  网关层          │  10.0.2.0/24     │  8080                │
│  应用服务层      │  10.0.3.0/24     │  8081-8090           │
│  数据存储层      │  10.0.4.0/24     │  3306, 6379, 27017   │
│  基础设施层      │  10.0.5.0/24     │  8848, 9092, 2181    │
└─────────────────────────────────────────────────────────────┘
```

## 🐳 Docker部署

### 开发环境部署

#### 1. 克隆项目

```bash
# 克隆项目代码
git clone https://gitee.com/stanChen/qing.git
cd qing

# 检查项目结构
ls -la
```

#### 2. 构建镜像

```bash
# 构建所有服务镜像
./scripts/build-images.sh

# 或者单独构建
docker build -t qing/auth-service:latest qing-services/qing-service-auth/
docker build -t qing/gateway-service:latest qing-service-cloud-gateway/
docker build -t qing/anime-service:latest qing-services/qing-service-anime/
```

#### 3. 启动基础设施

```bash
# 启动基础设施服务
docker-compose -f scripts/docker-compose-infra.yml up -d

# 检查服务状态
docker-compose -f scripts/docker-compose-infra.yml ps
```

#### 4. 初始化数据库

```bash
# 等待MySQL启动完成
sleep 30

# 执行初始化脚本
docker exec -i qing-mysql mysql -uroot -p123456 < scripts/init-db.sql

# 验证数据库
docker exec qing-mysql mysql -uroot -p123456 -e "SHOW DATABASES;"
```

#### 5. 启动应用服务

```bash
# 启动所有应用服务
docker-compose -f scripts/docker-compose-app.yml up -d

# 查看服务日志
docker-compose -f scripts/docker-compose-app.yml logs -f
```

#### 6. 验证部署

```bash
# 检查服务健康状态
curl http://localhost:8080/actuator/health
curl http://localhost:8081/actuator/health
curl http://localhost:8082/actuator/health

# 访问API文档
open http://localhost:8080/doc.html
```

### 完整的docker-compose配置

创建 `docker-compose.yml`：

```yaml
version: '3.8'

services:
  # 基础设施服务
  nacos:
    image: nacos/nacos-server:v2.2.3
    container_name: qing-nacos
    environment:
      - MODE=standalone
      - SPRING_DATASOURCE_PLATFORM=mysql
      - MYSQL_SERVICE_HOST=mysql
      - MYSQL_SERVICE_DB_NAME=nacos
      - MYSQL_SERVICE_USER=nacos
      - MYSQL_SERVICE_PASSWORD=nacos123
    ports:
      - "8848:8848"
    depends_on:
      - mysql
    networks:
      - qing-network

  mysql:
    image: mysql:8.0
    container_name: qing-mysql
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=qing
    ports:
      - "3306:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init.sql
    networks:
      - qing-network

  redis:
    image: redis:7-alpine
    container_name: qing-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - qing-network

  # 应用服务
  auth-service:
    image: qing/auth-service:latest
    container_name: qing-auth-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    ports:
      - "8081:8081"
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - qing-network

  gateway-service:
    image: qing/gateway-service:latest
    container_name: qing-gateway-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
    ports:
      - "8080:8080"
    depends_on:
      - nacos
      - auth-service
    networks:
      - qing-network

  anime-service:
    image: qing/anime-service:latest
    container_name: qing-anime-service
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - NACOS_SERVER_ADDR=nacos:8848
      - MYSQL_HOST=mysql
      - REDIS_HOST=redis
    ports:
      - "8082:8082"
    depends_on:
      - nacos
      - mysql
      - redis
    networks:
      - qing-network

volumes:
  mysql-data:
  redis-data:

networks:
  qing-network:
    driver: bridge
```

## ☸️ Kubernetes部署

### 生产环境部署

#### 1. 准备Kubernetes集群

```bash
# 检查集群状态
kubectl cluster-info
kubectl get nodes

# 创建命名空间
kubectl create namespace qing-prod
kubectl config set-context --current --namespace=qing-prod
```

#### 2. 安装Helm

```bash
# 安装Helm
curl https://get.helm.sh/helm-v3.12.0-linux-amd64.tar.gz | tar -xzO linux-amd64/helm > /usr/local/bin/helm
chmod +x /usr/local/bin/helm

# 验证安装
helm version
```

#### 3. 部署基础设施

##### MySQL部署

```yaml
# mysql-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql
  namespace: qing-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mysql
  template:
    metadata:
      labels:
        app: mysql
    spec:
      containers:
      - name: mysql
        image: mysql:8.0
        env:
        - name: MYSQL_ROOT_PASSWORD
          value: "123456"
        - name: MYSQL_DATABASE
          value: "qing"
        ports:
        - containerPort: 3306
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
      volumes:
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: mysql
  namespace: qing-prod
spec:
  selector:
    app: mysql
  ports:
  - port: 3306
    targetPort: 3306
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc
  namespace: qing-prod
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi
```

##### Redis部署

```yaml
# redis-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis
  namespace: qing-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-storage
          mountPath: /data
      volumes:
      - name: redis-storage
        persistentVolumeClaim:
          claimName: redis-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: redis
  namespace: qing-prod
spec:
  selector:
    app: redis
  ports:
  - port: 6379
    targetPort: 6379
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-pvc
  namespace: qing-prod
spec:
  accessModes:
  - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi
```

##### Nacos部署

```yaml
# nacos-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nacos
  namespace: qing-prod
spec:
  replicas: 1
  selector:
    matchLabels:
      app: nacos
  template:
    metadata:
      labels:
        app: nacos
    spec:
      containers:
      - name: nacos
        image: nacos/nacos-server:v2.2.3
        env:
        - name: MODE
          value: "standalone"
        - name: SPRING_DATASOURCE_PLATFORM
          value: "mysql"
        - name: MYSQL_SERVICE_HOST
          value: "mysql"
        - name: MYSQL_SERVICE_DB_NAME
          value: "nacos"
        - name: MYSQL_SERVICE_USER
          value: "nacos"
        - name: MYSQL_SERVICE_PASSWORD
          value: "nacos123"
        ports:
        - containerPort: 8848
---
apiVersion: v1
kind: Service
metadata:
  name: nacos
  namespace: qing-prod
spec:
  selector:
    app: nacos
  ports:
  - port: 8848
    targetPort: 8848
  type: ClusterIP
```

#### 4. 部署应用服务

##### 认证服务

```yaml
# auth-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth-service
  namespace: qing-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth-service
  template:
    metadata:
      labels:
        app: auth-service
    spec:
      containers:
      - name: auth-service
        image: qing/auth-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        - name: MYSQL_HOST
          value: "mysql"
        - name: REDIS_HOST
          value: "redis"
        ports:
        - containerPort: 8081
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8081
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: auth-service
  namespace: qing-prod
spec:
  selector:
    app: auth-service
  ports:
  - port: 8081
    targetPort: 8081
  type: ClusterIP
```

##### 网关服务

```yaml
# gateway-service-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: gateway-service
  namespace: qing-prod
spec:
  replicas: 2
  selector:
    matchLabels:
      app: gateway-service
  template:
    metadata:
      labels:
        app: gateway-service
    spec:
      containers:
      - name: gateway-service
        image: qing/gateway-service:latest
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "k8s"
        - name: NACOS_SERVER_ADDR
          value: "nacos:8848"
        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 60
          periodSeconds: 30
        readinessProbe:
          httpGet:
            path: /actuator/health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: gateway-service
  namespace: qing-prod
spec:
  selector:
    app: gateway-service
  ports:
  - port: 8080
    targetPort: 8080
  type: LoadBalancer
```

#### 5. 执行部署

```bash
# 部署基础设施
kubectl apply -f k8s/mysql-deployment.yaml
kubectl apply -f k8s/redis-deployment.yaml
kubectl apply -f k8s/nacos-deployment.yaml

# 等待基础设施就绪
kubectl wait --for=condition=ready pod -l app=mysql --timeout=300s
kubectl wait --for=condition=ready pod -l app=redis --timeout=300s
kubectl wait --for=condition=ready pod -l app=nacos --timeout=300s

# 部署应用服务
kubectl apply -f k8s/auth-service-deployment.yaml
kubectl apply -f k8s/gateway-service-deployment.yaml
kubectl apply -f k8s/anime-service-deployment.yaml

# 检查部署状态
kubectl get pods
kubectl get services
```

#### 6. 配置Ingress

```yaml
# ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: qing-ingress
  namespace: qing-prod
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  tls:
  - hosts:
    - api.qing.com
    secretName: qing-tls
  rules:
  - host: api.qing.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: gateway-service
            port:
              number: 8080
```

## 📊 监控部署

### Prometheus + Grafana

#### 1. 安装Prometheus Operator

```bash
# 添加Helm仓库
helm repo add prometheus-community https://prometheus-community.github.io/helm-charts
helm repo update

# 安装kube-prometheus-stack
helm install prometheus prometheus-community/kube-prometheus-stack \
  --namespace monitoring \
  --create-namespace \
  --set grafana.adminPassword=admin123
```

#### 2. 配置ServiceMonitor

```yaml
# service-monitor.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: qing-services
  namespace: monitoring
spec:
  selector:
    matchLabels:
      monitoring: "true"
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 30s
```

#### 3. 访问监控界面

```bash
# 获取Grafana访问地址
kubectl port-forward -n monitoring svc/prometheus-grafana 3000:80

# 访问 http://localhost:3000
# 用户名: admin
# 密码: admin123
```

### 日志收集

#### ELK Stack部署

```bash
# 安装Elasticsearch
helm repo add elastic https://helm.elastic.co
helm install elasticsearch elastic/elasticsearch \
  --namespace logging \
  --create-namespace

# 安装Kibana
helm install kibana elastic/kibana \
  --namespace logging

# 安装Filebeat
helm install filebeat elastic/filebeat \
  --namespace logging
```

## 🔧 配置管理

### 环境配置

#### 开发环境配置

```yaml
# application-dev.yml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/qing?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: root
    password: 123456
  redis:
    host: localhost
    port: 6379
    database: 0

cloud:
  nacos:
    discovery:
      server-addr: localhost:8848
    config:
      server-addr: localhost:8848

logging:
  level:
    cn.chenyunlong: DEBUG
```

#### 生产环境配置

```yaml
# application-prod.yml
spring:
  datasource:
    url: jdbc:mysql://mysql:3306/qing?useUnicode=true&characterEncoding=utf8&serverTimezone=Asia/Shanghai
    username: ${MYSQL_USERNAME:root}
    password: ${MYSQL_PASSWORD:123456}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  redis:
    host: ${REDIS_HOST:redis}
    port: ${REDIS_PORT:6379}
    database: 0
    lettuce:
      pool:
        max-active: 20
        max-idle: 10
        min-idle: 5

cloud:
  nacos:
    discovery:
      server-addr: ${NACOS_SERVER_ADDR:nacos:8848}
    config:
      server-addr: ${NACOS_SERVER_ADDR:nacos:8848}

logging:
  level:
    root: INFO
    cn.chenyunlong: INFO
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

### 配置中心管理

#### Nacos配置

```bash
# 创建配置文件
curl -X POST "http://nacos:8848/nacos/v1/cs/configs" \
  -d "dataId=qing-gateway.yml" \
  -d "group=DEFAULT_GROUP" \
  -d "content=$(cat gateway-config.yml)"

# 发布配置
curl -X POST "http://nacos:8848/nacos/v1/cs/configs" \
  -d "dataId=qing-auth.yml" \
  -d "group=DEFAULT_GROUP" \
  -d "content=$(cat auth-config.yml)"
```

## 🚀 CI/CD流水线

### GitLab CI配置

```yaml
# .gitlab-ci.yml
stages:
  - test
  - build
  - deploy

variables:
  DOCKER_REGISTRY: registry.example.com
  NAMESPACE: qing-prod

test:
  stage: test
  script:
    - mvn clean test
  only:
    - merge_requests
    - main

build:
  stage: build
  script:
    - mvn clean package -DskipTests
    - docker build -t $DOCKER_REGISTRY/qing/auth-service:$CI_COMMIT_SHA qing-services/qing-service-auth/
    - docker push $DOCKER_REGISTRY/qing/auth-service:$CI_COMMIT_SHA
  only:
    - main

deploy:
  stage: deploy
  script:
    - kubectl set image deployment/auth-service auth-service=$DOCKER_REGISTRY/qing/auth-service:$CI_COMMIT_SHA -n $NAMESPACE
    - kubectl rollout status deployment/auth-service -n $NAMESPACE
  only:
    - main
  when: manual
```

### Jenkins Pipeline

```groovy
// Jenkinsfile
pipeline {
    agent any
    
    environment {
        DOCKER_REGISTRY = 'registry.example.com'
        NAMESPACE = 'qing-prod'
    }
    
    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://gitee.com/stanChen/qing.git'
            }
        }
        
        stage('Test') {
            steps {
                sh 'mvn clean test'
            }
        }
        
        stage('Build') {
            steps {
                sh 'mvn clean package -DskipTests'
                sh 'docker build -t ${DOCKER_REGISTRY}/qing/auth-service:${BUILD_NUMBER} qing-services/qing-service-auth/'
                sh 'docker push ${DOCKER_REGISTRY}/qing/auth-service:${BUILD_NUMBER}'
            }
        }
        
        stage('Deploy') {
            steps {
                sh 'kubectl set image deployment/auth-service auth-service=${DOCKER_REGISTRY}/qing/auth-service:${BUILD_NUMBER} -n ${NAMESPACE}'
                sh 'kubectl rollout status deployment/auth-service -n ${NAMESPACE}'
            }
        }
    }
    
    post {
        always {
            cleanWs()
        }
    }
}
```

## 🔍 健康检查

### 应用健康检查

```bash
# 检查服务状态
kubectl get pods -n qing-prod
kubectl describe pod <pod-name> -n qing-prod

# 检查服务日志
kubectl logs -f deployment/auth-service -n qing-prod

# 检查服务健康端点
curl http://auth-service:8081/actuator/health
curl http://gateway-service:8080/actuator/health
```

### 数据库健康检查

```bash
# 检查MySQL连接
kubectl exec -it deployment/mysql -n qing-prod -- mysql -uroot -p123456 -e "SELECT 1"

# 检查Redis连接
kubectl exec -it deployment/redis -n qing-prod -- redis-cli ping
```

## 🛡️ 安全配置

### 网络安全

```yaml
# network-policy.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: qing-network-policy
  namespace: qing-prod
spec:
  podSelector: {}
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - namespaceSelector:
        matchLabels:
          name: qing-prod
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          name: qing-prod
```

### RBAC配置

```yaml
# rbac.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: qing-service-account
  namespace: qing-prod
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: qing-role
  namespace: qing-prod
rules:
- apiGroups: [""]
  resources: ["pods", "services"]
  verbs: ["get", "list", "watch"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: qing-role-binding
  namespace: qing-prod
subjects:
- kind: ServiceAccount
  name: qing-service-account
  namespace: qing-prod
roleRef:
  kind: Role
  name: qing-role
  apiGroup: rbac.authorization.k8s.io
```

## 📈 性能优化

### JVM调优

```yaml
# 在Deployment中配置JVM参数
env:
- name: JAVA_OPTS
  value: "-Xms512m -Xmx1g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+PrintGCDetails"
```

### 资源限制

```yaml
resources:
  requests:
    memory: "512Mi"
    cpu: "500m"
  limits:
    memory: "1Gi"
    cpu: "1000m"
```

## 🔄 备份恢复

### 数据库备份

```bash
# 创建备份脚本
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
kubectl exec deployment/mysql -n qing-prod -- mysqldump -uroot -p123456 --all-databases > $BACKUP_DIR/backup_$DATE.sql

# 压缩备份文件
gzip $BACKUP_DIR/backup_$DATE.sql

# 删除7天前的备份
find $BACKUP_DIR -name "*.gz" -mtime +7 -delete
```

### 配置备份

```bash
# 备份Nacos配置
curl "http://nacos:8848/nacos/v1/cs/configs?export=true&group=DEFAULT_GROUP" > nacos_config_backup.zip

# 备份Kubernetes配置
kubectl get all -n qing-prod -o yaml > k8s_backup.yaml
```

## 🚨 故障排查

### 常见问题

#### 服务启动失败

```bash
# 查看Pod状态
kubectl describe pod <pod-name> -n qing-prod

# 查看容器日志
kubectl logs <pod-name> -c <container-name> -n qing-prod

# 进入容器调试
kubectl exec -it <pod-name> -n qing-prod -- /bin/bash
```

#### 数据库连接问题

```bash
# 检查数据库服务
kubectl get svc mysql -n qing-prod

# 测试数据库连接
kubectl run mysql-client --image=mysql:8.0 -it --rm --restart=Never -- mysql -h mysql -uroot -p123456
```

#### 网络连接问题

```bash
# 检查网络策略
kubectl get networkpolicy -n qing-prod

# 测试服务连通性
kubectl run test-pod --image=busybox -it --rm --restart=Never -- nslookup auth-service
```

## 📚 相关文档

- [快速开始](快速开始.md) - 5分钟快速上手
- [用户指南](用户指南.md) - 详细使用说明
- [架构设计](架构设计.md) - 系统架构设计
- [ROADMAP](../ROADMAP.md) - 项目发展路线
- [CONTRIBUTING](../CONTRIBUTING.md) - 贡献指南

---

> 💡 **部署建议**: 建议先在测试环境验证部署流程，确认无误后再部署到生产环境。生产环境部署前请务必做好数据备份。