@startuml

!include ./eventstorming/single.puml

scale 1.5

actor 管理员 as 管理员
actor 用户 as 用户


DomainEvent("动漫已创建") [
动漫已创建
--字段--
动漫Id
创建时间
创建者
]

DomainEvent("动漫下架完成") [
动漫下架完成
--字段--
动漫Id
下架时间
操作人
]

DomainEvent("动漫上架完成") [
动漫上架完成
--字段--
动漫Id
上架时间
操作人
]

DomainEvent("动漫删除完成") [
动漫删除完成
--字段--
动漫Id
删除时间
操作人
]

DomainEvent("评论已提交") [
评论已提交
--字段--
评论Id
内容
用户标识
动漫Id
提交时间
]

DomainEvent("评论审核通过") [
评论审核通过
--字段--
评论Id
审核时间
审核人
]

DomainEvent("评论审核驳回") [
评论审核驳回
--字段--
评论Id
驳回时间
驳回原因
]

DomainEvent("评论被屏蔽") [
评论被屏蔽
--字段--
评论Id
屏蔽时间
操作人
屏蔽原因
]

DomainEvent("评论被移除") [
评论被移除
--字段--
评论Id
移除时间
操作人
移除原因
]

DomainEvent("用户注册成功") [
用户注册成功
--字段--
用户标识
注册时间
注册IP
]

DomainEvent("用户激活完成") [
用户激活完成
--字段--
用户标识
激活时间
]

DomainEvent("用户密码重置") [
用户密码重置
--字段--
用户标识
重置时间
重置IP
]

DomainEvent("用户账号锁定") [
用户账号锁定
--字段--
用户标识
锁定时间
锁定原因
]

DomainEvent("用户账号解锁") [
用户账号解锁
--字段--
用户标识
解锁时间
解锁人
]

Command("创建动漫") [
创建动漫
--规则--
动漫Id不存在
名称不能为空（1-50字）
简介不超过200字
--字段--
动漫Id
名称
简介
封面图URL
类型
状态
]

Command("提交评论") [
提交评论
--规则--
用户已登录
动漫存在且可评论
--字段--
评论内容
动漫Id
]

Command("审核评论") [
审核评论
--规则--
评论处于待审核状态
审核人有权限
--字段--
评论Id
审核结果
审核意见
]

Command("管理上架") [
管理上架
--规则--
动漫处于下架或未上架状态
--字段--
动漫Id
上架时间
]

Command("管理下架") [
管理下架
--规则--
动漫处于已上架状态
--字段--
动漫Id
下架时间
下架原因
]

Command("删除动漫") [
删除动漫
--规则--
动漫处于已下架状态
未被彻底删除
--字段--
动漫Id
删除原因
]

Command("锁定用户账号") [
锁定用户账号
--规则--
用户账号正常
--字段--
用户标识
锁定原因
]

Command("解锁用户账号") [
解锁用户账号
--规则--
用户账号被锁定
--字段--
用户标识
解锁理由
]

Command("重置用户密码") [
重置用户密码
--规则--
用户账号正常
--字段--
用户标识
新密码
]

Aggregate("动漫聚合")[
动漫聚合
--id--
动漫Id
--fields--
名称
简介
封面图URL
类型
创建时间
上架状态
删除状态
审核状态
发布日期
修改截止时间
--methods--
canBeEdited()
isAvailableForComment()
]

Aggregate("评论聚合")[
评论聚合
--id--
评论Id
--fields--
内容
用户标识
动漫Id
提交时间
审核状态
屏蔽状态
删除状态
回复数量
举报次数
--methods--
canBeEdited()
canBeDeleted()
]

Aggregate("用户聚合")[
用户聚合
--id--
用户标识
--fields--
用户名
注册时间
最后登录时间
邮箱
注册IP
状态（启用/锁定）
密码重置状态
--methods--
validatePasswordStrength()
sendVerificationCode()
]

ReadModel("动漫信息")[
动漫信息
----
名称
简介
封面图URL
类型
评分
上架状态
最新评论（3条）
]

ReadModel("用户概览")[
用户概览
----
用户标识
用户名
注册时间
最后登录时间
账号状态
]

ReadModel("评论详情")[
评论详情
----
评论内容
用户信息
提交时间
审核状态
屏蔽状态
操作记录
]

ReadModel("审核日志")[
审核日志
----
评论Id
审核时间
审核结果
审核人
审核意见
]

ReadModel("通知记录")[
通知记录
----
用户标识
通知类型
通知内容
发送时间
]

动漫已创建 -down-> 动漫信息 : 包含
动漫已上架完成 -down-> 动漫信息 : 更新状态
动漫已下架完成 -down-> 动漫信息 : 更新状态
动漫已删除完成 -down-> 动漫信息 : 移除

用户 -down-> 提交评论 : 触发
提交评论 -right-> 审核队列 : 加入待审列表
提交评论 -down-> 评论聚合 : 创建记录
评论聚合 -down-> 评论已提交 : 记录事件

管理员 -down-> 审核评论 : 执行审核
审核评论 -down-> 评论聚合 : 更新状态
审核评论 -down-> 审核日志 : 记录操作
审核评论 -right-> 系统通知 : 发送审核结果通知

评论聚合 -down-> 评论审核通过 : 触发事件
评论聚合 -down-> 评论审核驳回 : 触发事件
评论聚合 -down-> 评论被屏蔽 : 触发事件
评论聚合 -down-> 评论被移除 : 触发事件

用户 -down-> 删除评论 : 发起删除请求
删除评论 -right-> 审核队列 : 加入待审列表（如果是敏感内容）
删除评论 -down-> 评论聚合 : 执行删除

动漫聚合 -down-> 管理上架 : 验证并更新状态
管理上架 -down-> 动漫已上架完成 : 记录事件

锁定用户账号 -down-> 用户聚合 : 更新状态
用户聚合 -down-> 用户账号锁定 : 记录事件
用户账号锁定 -right-> 系统通知 : 发送锁定通知
用户账号锁定 -right-> 日志服务 : 记录操作日志

新增用户信息 -down-> 用户聚合 : 创建用户记录
用户聚合 -down-> 用户已注册成功 : 记录事件
用户已注册成功 -down-> 用户概览 : 同步数据
用户已注册成功 -right-> 系统通知 : 发送注册确认通知

用户 -down-> 用户重置密码 : 发起重置
用户重置密码 -down-> 用户聚合 : 更新密码状态
用户聚合 -down-> 用户密码重置 : 记录事件
用户密码重置 -right-> 短信服务 : 发送验证码
用户密码重置 -right-> 日志服务 : 记录操作日志

评论聚合 -down-> 评论被屏蔽 : 触发事件
评论被屏蔽 -right-> 系统通知 : 发送屏蔽通知
评论被屏蔽 -right-> 日志服务 : 记录操作日志

@enduml
